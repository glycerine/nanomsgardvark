#!/bin/bash
exec R --vanilla -q --slave -e "source(file=pipe(\"tail -n +4 $0\"))" --args $@
#debug: exec R --vanilla --verbose -e "source(file=pipe(\"tail -n +6 $0\"))" --args $@

library(nanomsgardvark)

# nanomsg endpoint to use in tests cases.
#test.ENDPOINT <- "inproc://poll"
#test.ENDPOINT <- "ipc:///tmp/test.ipc"
test.ENDPOINT <- "tcp://127.0.0.1:5551"
# remote tcp: 25K msg/sec, at msg size 1010 bytes.
# local tcp with R grep on each msg: 13K msg/sec, at msg size 1010 bytes.


# Testing helpers.
assert <- function(condition, message="Assertion Failed") if(!condition) stop(message)
assert.fails <- function(expr, message="Assertion Failed") {
    result <- try(expr, TRUE)
    assert(inherits(result, 'try-error'), message)
}


    s.push <- nn.socket(nn.AF_SP, nn.PUSH)

    nn.clearerr()
    rc = nn.connect(s.push, test.ENDPOINT)
    assert(rc > 0, "nn.connect() should return positive endpoint id")
    msg="Hello from sendmsg.R01234567890012345678900123456789001234567890012345678900123456789001234567890012345678900123456789001234567890012345678900123456789001234567890012345678900123456789001234567890012345678900123456789001234567890012345678900123456789001234567890012345678900123456789001234567890012345678900123456789001234567890012345678900123456789001234567890012345678900123456789001234567890012345678900123456789001234567890012345678900123456789001234567890012345678900123456789001234567890012345678900123456789001234567890012345678900123456789001234567890012345678900123456789001234567890012345678900123456789001234567890012345678900123456789001234567890012345678900123456789001234567890012345678900123456789001234567890012345678900123456789001234567890012345678900123456789001234567890012345678900123456789001234567890012345678900123456789001234567890012345678900123456789001234567890012345678900123456789001234567890012345678900123456789001234567890012345678900123456789001234567890012345678900123456789001234567890012345678900123456789001234567890012345678900123456789001234567890012345678900123456789001234567890World"

    n=1000000
    print(paste("start at ",date()))
    for (i in 1:n) {
       nn.send(s.push,msg,serialize=T)
    }
    print(paste("end at ",date(),"after",n))
